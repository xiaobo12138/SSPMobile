<!--招待申请-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<title>招待申请</title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/label.css" rel="stylesheet" />
		<script src="js/rem.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery-3.1.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/reques.js"></script>
		<script src="js/adress.js"></script>
		<link rel="stylesheet" type="text/css" href="css/master.css" />
		<style>
			body {
				background: white;
			}
		</style>
	</head>

	<body>
		<!--页脚-->
		<div id="suspend" style="background: #ececec;position: fixed;z-index: 5000;bottom: 0px;right: 0;left: 0;padding-bottom: 10px;padding-top: 10px;">
			<button class="mui-pull-right detail-agreeBtn" style="margin-right: 15px;" onclick="agree()">同意</button>
			<button class="mui-pull-right detail-disagreeBtn" onclick="disAgree()">不同意</button>
		</div>
		<!--页头-->
		<header id="header" class="mui-bar mui-bar-nav" style="background: #2385ff;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: #FFFFFF;"></a>
			<!--返回-->
			<h1 class="mui-title" style="color: #FFFFFF;">详情</h1>
		</header>
		<!--主体-->
		<div class="mui-content">
			<ul id="content" class="mui-table-view" style="margin-bottom: 1.2rem;">
				<!--个人信息-->
				<li id="information" class="mui-table-view-cell" style="padding: 0rem 0.4rem!important;padding-top: 15px!important;padding-bottom: 15px!important;position: relative;">

				</li>
				<!--预算-->
				<li id="budget" class="mui-table-view-cell mui-media" style="background:#FFFFFF;padding-top: 15px!important;padding-bottom: 15px!important;">

				</li>

				<!--单据照片-->
				<li id="photos" class="mui-table-view-cell mui-media" style="background:#FFFFFF;">

				</li>

				<!--审批状态-->
				<li id="approve" class="mui-table-view-cell mui-media" style="background:#FFFFFF;">

				</li>
			</ul>
		</div>

		<!--点击同意，弹出的悬浮界面-->
		<div id="middlePopover" class="mui-popover" style="height: 400px;background: white;">
			<div>
				<button class="mui-pull-right deletBtn" onclick="colsePover()">x</button>
				<p class="titleP">同意</p>
			</div>
			<div class="row mui-input-row">
				<textarea id='question' class="mui-input-clear question" style="width: -webkit-fill-available;margin-left: 15px;margin-right: 15px;background: #ececec;">同意</textarea>
			</div>
			<div id="leader" style="margin-bottom: 15px;margin-left: 15px;display: none;">
				<label for="director">是否主任审批：</label>
				<input type="radio" name="director" value="1" checked="checked" style="color: red;" /> 是
				<input type="radio" name="director" value="0" /> 否
			</div>
			<!--下一审批人-->
			<div id="nextPeople" style="margin:15px;">
				<p style="margin-bottom: 15px;">下一个审批人</p>
				<table id="nextPerson" style="width: 100%;">
				</table>
			</div>
			<!--提交-->
			<button class="detail-agreeBtn" onclick="submit()" style="margin-right: 15px;margin-left: 15px;width: 90%;">提交</button>
		</div>

		<!--点击不同意弹出的浮层-->
		<div id="disagreePopover" class="mui-popover" style="height: 200px;background: white;">
			<div>
				<button class="mui-pull-right deletBtn" onclick="colsePover()">x</button>
				<p class="titleP">不同意</p>
			</div>
			<div class="row mui-input-row">
				<textarea id='textContent' class="mui-input-clear question" placeholder="填写意见..." required="required" style="width: -webkit-fill-available;margin-left: 15px;margin-right: 15px;background: #ececec;"></textarea>
			</div>
			<button class="detail-agreeBtn" onclick="disSubmit()" style="margin-right: 15px;margin-left: 15px;width: 90%;">提交</button>
		</div>

		<!--加载动画-->
		<div id="loadingPopover" class="mui-popover">
			<div class="loading-block">
				<img src="images/5-121204193R5-50.gif" style="width: 1rem;height: 1rem;">
			</div>
		</div>

		<script>
			//关闭浮层
			function colsePover() {
				mui('#middlePopover').popover('hide');
				mui('#disagreePopover').popover('hide');
			}

			function agree() {
				if(activityCode != "Activity8" && activityCode != "Activity9" && activityCode != "Activity11" && activityCode != "Activity56") {
					mui.alert("报销管理员请到PC端处理", ' ', function() {

					});
				} else {
					mui('#middlePopover').popover('show');
				}
			}

			function disAgree() {
				if(activityCode != "Activity8" && activityCode != "Activity9" && activityCode != "Activity11" && activityCode != "Activity56") {
					mui.alert("报销管理员请到PC端处理", ' ', function() {

					});
				} else {
					mui('#disagreePopover').popover('show');
				}
			}
			//不同意提交
			function disSubmit() {
				//关闭浮层
				mui('#disagreePopover').popover('hide');
				var text = document.getElementById("textContent");
				if(text.value.length <= 0) {
					//			mui('#disagreePopover').popover('hide');
					//提示：请写明不同意的原因
					mui.alert("请写明不同意的原因", ' ', function() {

						mui('#disagreePopover').popover('show');
					});
				} else {
					var disUrl = get_Url() + '/iServer/common/rejectApply?';
					var myData = {
						instanceId: instanceId,
						userCode: useruuid,
						checkMsg: text.value, //审批意见
						type: '1', //驳回类型（1：驳回到起始节点 2：驳回到上个节点 3：驳回到指定节点）
						workFlowCode: 'EntertainDinnerApplication'
					};
					$.ajax({
						type: "post",
						url: disUrl,
						data: myData,
						beforeSend: function() {
							mui('#loadingPopover').popover('show');
						},
						complete: function() {
							mui('#loadingPopover').popover('hide');
						},
						success: function(data) {
							var jsonData = JSON.parse(data);
							mui.alert(jsonData.msg, ' ', function() {
								//返回上层界面
								goBack();
							});
						},
						error: function(xhr, type, errorThrown) {
							//异常处理；
							console.log(type);
							mui.toast('失败了');
						}
					});
				}
			}

			//同意提交
			function submit() {
				//关闭浮层
				mui('#middlePopover').popover('hide');
				var text = document.getElementById("question");
				var isLeader = document.getElementsByName("director");
				for(i = 0; i < isLeader.length; i++) {
					if(isLeader[i].checked) {
						Is_NeedMasterApproval = isLeader[i].value;
					}
				}
				if(Is_NeedMasterApproval == 0) { //不需要主任审批
					personId = '';
				} else {
					var nextDirector = document.getElementsByName("nextDirector");
					if(nextDirector.length > 0) {
						for(i = 0; i < nextDirector.length; i++) {
							if(nextDirector[i].checked) {
								personId = personArr[i].OrgCode;
							}
						}
					} else {
						personId = '';
					}
				}

				//调同意接口
				var url = get_Url() + '/iServer/receptionapply/submitApply';
				var myData = {
					id: idStr, //20180508300031820989
					instanceId: instanceId, //d55d9b00-247a-4cfc-8531-e59ca5c3f3fe
					approvalOpinion: text.value, //意见
					loginUserCode: useruuid, //自己的账号
					unitCode: '', //提单人部门Code：空/
					approvalNextUser: personId, //下一节点审批人id
					approvalState: '同意', //审批状态
					expenseId: '', //报销人ID
					expenseCode: '' //报销人Code
				};
				$.ajax({
					type: "post",
					url: url,
					data: myData,
					beforeSend: function() {
						mui('#loadingPopover').popover('show');
					},
					complete: function() {
						mui('#loadingPopover').popover('hide');
					},
					success: function(data) {
						var jsonData = JSON.parse(data);
						mui.alert(jsonData.msg, ' ', function() {
							//返回上层界面
							goBack();
						});
					},
					error: function(xhr, type, errorThrown) {
						//异常处理；
						console.log(type);
						mui.toast('失败了');
					}
				});
			}

			function goBack() {
				window.history.back(-1);

			}

			function plusReady() {
				//获取列表界面传回的数据
				var temp = window.localStorage.getItem("SSP_listToDetail");
				listType = JSON.parse(temp).listType;
				idStr = JSON.parse(temp).id; //id名
				var headImg = JSON.parse(temp).headImg;
				var name = JSON.parse(temp).userName;
				var type = JSON.parse(temp).instanceName;
				var money = JSON.parse(temp).money;
				var content = JSON.parse(temp).receptionProject;
				var state = JSON.parse(temp).state;
				var time = JSON.parse(temp).time;
				instanceId = JSON.parse(temp).instanceId;
				workItemId = JSON.parse(temp).workItemId;
				activityCode = JSON.parse(temp).activityCode;
				workflowCode = JSON.parse(temp).workflowCode;
				useruuid = JSON.parse(temp).useruuid;
				token = JSON.parse(temp).token;

				//先调选择下个审批人接口
				var url = get_Url() + '/iServer/test/getNextNode';
				var myData = {
					workItemId: workItemId
				};
				$.ajax({
					type: "post",
					url: url,
					data: myData,
					success: function(data) {
						var jsonData = JSON.parse(data);
						personArr = new Array();
						var countP = personArr.length;
						var nextPeople = document.getElementById("nextPeople");
						if(countP == 0) {
							nextPeople.style.display = "none";
						}
						var dex = Math.round(countP / 3); //小数转成整数（会四舍五入）

						if(countP % 3 == 0) {
							dex1 = dex;
						} else {
							dex1 = dex + 1;
						}

						for(var i = 0; i < dex1; i++) {
							var personReq = "";
							personReq += '<tr style="width: 100%;">';
							for(var j = i * 3; j <= (i + 1) * 3 - 1; j++) {
								if(j < countP) {
									if(i == 0 && j == 0) {
										personReq += '<td align="left"><label style="width: (100%/3);"><input type="radio" name="nextDirector" value="1" checked="checked"/></label>' + "   " + personArr[j].OrgName + '</td>';
									} else {
										personReq += '<td align="left"><label style="width: (100%/3);"><input type="radio" name="nextDirector" value="1"/></label>' + "   " + personArr[j].OrgName + '</td>';
									}
								}
							}
							personReq += '</tr>';
							var table = document.getElementById("nextPerson");
							var tr = document.createElement("tr");
							tr.innerHTML = personReq;
							table.appendChild(tr);
						}

					},
					error: function(xhr, type, errorThrown) {
						//异常处理；
						console.log(type);
						mui.toast('失败了');
					}
				});

				var approveArr = new Array(); //审批状态
				var photosArr = new Array(); //单据图片
				var trafficArr = new Array(); //行程
				var budgetArr = new Array(); //预算

				//单据图片
				var photosUrl = get_Url() + '/img/documents/PictureDisplay';
				var myData = {
					id: idStr
				};
				$.ajax({
					type: "post",
					url: photosUrl,
					data: myData,
					success: function(data) {
						var jsonData = JSON.parse(data);
						//alert('单据图片');
						photosArr = jsonData.pd;
						if(photosArr.length == 0) {
							var pp = document.getElementById("photos");
							pp.classList.add('mui-hidden');
						} else {
							//先过滤掉不是图片的附件
							var picturesArr = new Array();
							for(var j = 0; j < photosArr.length; j++) {
								if(photosArr[j].fileType == "jpg" || photosArr[j].fileType == "png" || photosArr[j].fileType == "jpeg") {
									//
									picturesArr.push(photosArr[j]);
								}
							}
							var photosCount = picturesArr.length;
							var photosReq = '';
							photosReq += '<img src="images/left.png" class="detail-leftImg"/>';
							photosReq += '<span class="detail-type">单据照片</span>';
							photosReq += '<div style="height: 15px;"></div>';
							photosReq += '<table>';
							photosReq += '<tr>';

							for(var i = 0; i < photosCount; i++) {
								photosReq += '<td style="width: 1.2rem;">';
								var imgUrl = get_Url() + '/img/documents/getImagesById?id=' + picturesArr[i].id;
								photosReq += '<img src=' + imgUrl + ' class="detail-photo" data-preview-src="" data-preview-group="1"/>';
								photosReq += '<span class="detail-photo-number">' + (i + 1) + '</span>';
								photosReq += '</td>';
							}
							photosReq += '</tr>';
							photosReq += '</table>';
							photosReq += '<div style="height: 10px;"></div>';
							var li2 = document.getElementById("photos");
							li2.innerHTML = photosReq;
						}

					},
					error: function(xhr, type, errorThrown) {
						console.log(type);
						mui.toast('失败了');
					}
				});

				//审批状态
				var approveUrl = get_Url() + '/iServer/comment/list?page=1&rows=100&sidx=id&sord=aesc';
				var myData = {
					instanceId: instanceId
				};
				$.ajax({
					type: "get",
					url: approveUrl,
					data: myData,
					success: function(data) {
						var jsonData = JSON.parse(data);
						approveArr = jsonData.rows;
						var approveCount = approveArr.length;
						if(approveCount == 0) {
							var po = document.getElementById("approve");
							po.classList.add('mui-hidden');
						} else {
							var approveReq = '';
							approveReq += '<img src="images/left.png" class="detail-leftImg"/>';
							approveReq += '<span class="detail-type">审批状态</span>';
							approveReq += '<div style="height: 15px;"></div>';
							for(var i = 0; i < approveCount; i++) {
								var time = get_Date((approveArr[i].approvalDate / 1000));
								//截取字符串，显示月日时分秒
								var approveTime = time.substring(5, 19);
								approveReq += '<div style="margin-bottom: 10px;">';
								approveReq += '<table style="width: 100%;">';
								approveReq += '<tr style="width: 100%;">';
								approveReq += '<td style="width: 45%;">';
								approveReq += '<span class="mui-badge detail-journey-number" style="padding: 0.03rem 0.08rem;">' + (i + 1) + '</span>';
								approveReq += '<span class="detail-leader-name">' + approveArr[i].approvalUserName + '</span>';
								if(approveArr[i].approvalState == "同意" || approveArr[i].approvalState == "1") {
									approveReq += '<span class="detail-leader-pass">同意</span>';
								}
								if(approveArr[i].approvalState == "不同意" || approveArr[i].approvalState == "0") {
									approveReq += '<span class="detail-leader-pass" style="background: #d34f4f">不同意</span>';
								}
								approveReq += '<img src="images/three-pin.png" class="detail-leader-three"/>';
								approveReq += '<div>';
								approveReq += '<table style="width: 100%;">';
								approveReq += '<tr>';
								if(i == (approveCount - 1)) { //最后一个不显示...
									approveReq += '<td>';
									approveReq += '<p class="detail-leader-time" style="margin-left: 0.5rem;">' + approveTime + '</p>';
									approveReq += '</td>';
								} else {
									approveReq += '<td style="padding: 0.04rem;" align="center">';
									approveReq += '<div style="margin-top: -7px;"><span style="color: black;">.</span></div>';
									approveReq += '<div style="margin-top: -11px;"><span style="color: black;">.</span></div>';
									approveReq += '<div style="margin-top: -11px;"><span style="color: black;">.</span></div>';
									approveReq += '</td>';
									approveReq += '<td>';
									approveReq += '<p class="detail-leader-time">' + approveTime + '</p>';
									approveReq += '</td>';
								}
								approveReq += '</tr>';
								approveReq += '</table>';
								approveReq += '</div>';
								approveReq += '</td>';
								approveReq += '<td style="width: 55%;" class="detail-leader-content">' + approveArr[i].approvalOpinion + '</td>';
								approveReq += '</tr>';
								approveReq += '</table>';
								approveReq += '</div>';
							}
							var li3 = document.getElementById("approve");
							li3.innerHTML = approveReq;
						}
					}
				});

				//行程和预算
				var url = get_Url() + '/iServer/receptionapply/queryReceptionApplyInfoById?';
				var myData = {
					id: idStr
				};
				$.ajax({
					type: "post",
					url: url,
					data: myData,
					success: function(data) {
						var jsonData = JSON.parse(data);
						if(jsonData.status_code == 1) {
							var li1 = document.getElementById("budget");
							budgetArr = jsonData.userData.departmentList;
							if(budgetArr.length == 0) {
								li1.classList.add('mui-hidden');
							} else {
								var budgetReq = "";
								budgetReq += '<img src="images/left.png" class="detail-leftImg"/>';
								budgetReq += '<span class="detail-type">预算</span>';
								budgetReq += '<li class="mui-table-view-cell mui-media" style="background:#FFFFFF;padding-left:0px;padding-right:0px;">';
								budgetReq += '<table style="width: 100%;">';
								budgetReq += '<tr style="width: 100%;">';
								budgetReq += '<td style="width: 15%;"  valign="top">';
								budgetReq += '<p class="detail-title">名称</p>';
								budgetReq += '</td>';
								budgetReq += '<td style="width: 85%;"  align="right" valign="top">';
								if(jsonData.userData.receptionType == '0') {
									budgetReq += '<p class="detail-cost">商务接待</p>';
								} else if(jsonData.userData.receptionType == '1') {
									budgetReq += '<p class="detail-cost">公务接待</p>';
								} else {
									budgetReq += '<p class="detail-cost">外事接待</p>';
								}
								budgetReq += '</td>';
								budgetReq += '</table>';
								budgetReq += '<div style="height: 0.2rem;"></div>';
								budgetReq += '<span class="detail-title">编号</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + jsonData.userData.id + '</span>';
								budgetReq += '<div style="height: 0.2rem;"></div>';
								budgetReq += '</li>';
								budgetReq += '<li class="mui-table-view-cell mui-media" style="background:#FFFFFF;position: static;padding-left:0px;padding-right:0px;">';
								budgetReq += '<span class="detail-title">接待单位</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + jsonData.userData.sendUnit + '</span>';
								budgetReq += '<div style="height: 0.4rem;"></div>';
								budgetReq += '<span class="detail-title">接待对象</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + jsonData.userData.receptionObject + '</span>';
								budgetReq += '<div style="height: 0.4rem;"></div>';
								budgetReq += '<span class="detail-title">陪同人员</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + jsonData.userData.entourage + '</span>';
								budgetReq += '<div style="height: 0.4rem;"></div>';
								budgetReq += '<span class="detail-title">接待地点</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + jsonData.userData.receptionPlace + '</span>';
								budgetReq += '<div style="height: 0.4rem;"></div>';
								budgetReq += '<span class="detail-title">接待标准</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + jsonData.userData.receptionStandard + '</span>';
								budgetReq += '<div style="height: 0.4rem;"></div>';
								budgetReq += '<span class="detail-title">接待人数</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + jsonData.userData.receptionObjectNum + '</span>';
								budgetReq += '<div style="height: 0.4rem;"></div>';
								budgetReq += '<span class="detail-title">接待事由</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + jsonData.userData.receptionProject + '</span>';
								var time = get_Date((jsonData.userData.receptionTime / 1000));
								var approveTime = time.substring(0, 10);
								budgetReq += '<div style="height: 0.4rem;"></div>';
								budgetReq += '<span class="detail-title">接待时间</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + approveTime + '</span>';
								budgetReq += '<div style="height: 0.4rem;"></div>';
								var expectedCost = formatCurrency(jsonData.userData.expectedCost);
								var souvenirCost = formatCurrency(jsonData.userData.souvenirCost);

								budgetReq += '<span class="detail-title">接待费用</span>';
								budgetReq += '<span class="detail-standard">(纪念品标准' + '￥' + souvenirCost + ')</span>';
								budgetReq += '<span class="mui-pull-right detail-cost">' + '￥' + expectedCost + '</span>';
								budgetReq += '<div style="height: 0.4rem;"></div>';
								budgetReq += '<div style="height: 0.4rem;"></div>';
								budgetReq += '<span class="detail-cost">合计</span>';
								var totalFee = formatCurrency(jsonData.userData.expectedCost);
								budgetReq += '<span class="mui-pull-right detail-cost">' + "￥" + expectedCost + '</span>';
								budgetReq += '<div style="height: 15px;"></div>';
								budgetReq += '</li>';
								li1.innerHTML = budgetReq;
							}

						} else {
							mui.toast('失败了');
						}
					},
					error: function(xhr, type, errorThrown) {
						mui.toast('请求失败了');
					}
				});
				if(listType == "已办") {
					var suspend = document.getElementById("suspend");
					suspend.classList.add('mui-hidden');
				}

				//展示个人信息模块
				var req = '';
				req += '<img class="mui-media-object mui-pull-left list-headImg" src="images/head2.png">';
				req += '<div class="mui-media-body">';
				req += '<a href="javascript:;" style="color:#1b82d2;">';
				req += '<span class="list-name">' + name + '</span> ';
				req += '</a>';
				if(type == '交通费报销') {
					req += '<span class="list-chai" style="vertical-align: top;">交</span>';
				} else if(type == '差旅费报销' || type == '出差申请') {
					req += '<span class="list-chai" style="vertical-align: top;">差</span>';
				} else if(type == '通讯费报销') {
					req += '<span class="list-chai" style="vertical-align: top;">通</span>';
				} else if(type == '招待费报销' || type == '招待申请') {
					req += '<span class="list-chai" style="vertical-align: top;">待</span>';
				} else if(type == '会议费报销' || type == '会议费申请') {
					req += '<span class="list-chai" style="vertical-align: top;">会</span>';
				} else if(type == '加油费报销') {
					req += '<span class="list-chai" style="vertical-align: top;">油</span>';
				} else if(type == '其他费报销') {
					req += '<span class="list-chai" style="vertical-align: top;">其</span>';
				} else {
					req += '<span class="list-chai" style="vertical-align: top;">餐</span>';
				}
				req += '<span style="color: #333333;font-size: 0.42rem;margin-left: 0.15rem;">' + type + ':</span>';
				req += '<span style="color: #cc1c1c;font-size: 0.42rem;">￥' + money + '</span>';
				if(content == null) {
					req += '<p class="list-content"></p>';
				} else {
					req += '<p class="list-content">' + content + '</p>';
				}
				if(state !== "空") {
					req += '<span class="list-yihedui">' + state + '</span>';
				}
				req += '<span class="mui-pull-right list-time">' + time + '</span>';
				req += '</div>';
				var content = document.getElementById("content")
				var li = document.getElementById("information");
				li.innerHTML = req;
			}

			plusReady();
		</script>
	</body>
	<script src="js/mui.zoom.js"></script>
	<script src="js/mui.previewimage.js"></script>
	<script>
		//图片预览
		mui.previewImage(function(img) {
			//打开预览时
			var suspend = document.getElementById("suspend");
			suspend.classList.add('mui-hidden');
		}, function(img) {
			//关闭预览时
			if(listType == "待办") {
				var suspend = document.getElementById("suspend");
				suspend.classList.remove("mui-hidden");
			}
		});
	</script>

</html>